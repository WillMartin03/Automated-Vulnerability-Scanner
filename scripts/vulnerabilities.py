import os, platform, subprocess

def createList():
	portlist = []
	try:
		with open("./ports.txt", "r") as f:
			for line in f:
				line = line.strip()
				if line == "\x90":
					break
				portlist.append(line)
		return portlist
	except Exception as e:
		print(e)
		print("Error detected, exiting...")
		exit()

def start():
	print("Start Vulnerability Scan...")
	portlist = createList()
	for i in range(1, len(portlist)):
		scan(portlist[0], portlist[i])
	print("Vulnerability Scan Complete!")

def scan(ip, port):
	print(ip + ":" + port)

	if (platform.system() == "Windows"):
		pre = "C:\\Tools\\metasploit-framework\\bin\\"
		ext = ".bat"
	else:
		pre = ""
		ext = ""

	result = subprocess.run(f"{pre}msfconsole{ext} -q -x \"use auxiliary/scanner/http/http_version; set RHOSTS {ip}; set RPORT {port}; run; exit\"",
						shell=True,
						stdout=subprocess.PIPE,
						stderr=subprocess.PIPE,
						text=True)

	if (result.returncode == 0):
		print(result.stdout)
	else:
		print(result.stderr)
	return

if __name__ == "__main__":
	print(f"Starting from {os.path.basename(__file__)}. This is usually for developer purposes, please make sure this is intentional.\nIf you want to run the full program, please execute the 'AVS.py' file instead.")
	start()